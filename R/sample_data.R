library(renv)
library(readr)
library(ggplot2)
library(lubridate)
library(dplyr)
#library(KMEANS.KNN)
library(cluster)
#library(FNN)
library(nngeo)

snapshot()

rm(list=ls());cat('\f');gc()

at_64rt <- read_csv("latitude,longitude,update_time,speed,heading,message
35.774607,-78.644003,2025-04-15T09:45:00-04:00,,,
35.795429,-78.696894,2025-04-15T10:04:32-04:00,70.86,370,
35.790256,-78.714732,2025-04-15T10:06:05-04:00,69.02,225,
35.791477,-78.772593,2025-04-15T10:10:32-04:00,33.69,225,
35.789047,-78.783076,2025-04-15T10:12:31-04:00,0.03,370,
35.789058,-78.783076,2025-04-15T10:16:04-04:00,0.02,370,
35.789558,-78.78477,2025-04-15T10:17:36-04:00,34.44,370,
35.826587,-78.827235,2025-04-15T10:21:04-04:00,58.48,315,
35.904537,-78.852771,2025-04-15T10:26:04-04:00,70.1,0,
35.975116,-78.870501,2025-04-15T10:31:34-04:00,75.7,315,
35.996967,-78.906291,2025-04-15T10:34:36-04:00,0.05,315,
35.998638,-78.90932,2025-04-15T10:37:06-04:00,30.48,315,
36.028846,-78.960376,2025-04-15T10:40:34-04:00,49.75,315,
36.040378,-79.039386,2025-04-15T10:46:05-04:00,50.88,370,
36.064846,-79.092662,2025-04-15T10:51:06-04:00,33.1,315,
36.077678,-79.157931,2025-04-15T10:56:34-04:00,50.08,315,
36.092239,-79.249736,2025-04-15T11:01:05-04:00,79.14,370,
36.091918,-79.33723,2025-04-15T11:06:06-04:00,46.89,370,
35.774607,-78.644003,2025-04-14T09:45:00-04:00,,,
35.775917,-78.646495,2025-04-14T10:02:07-04:00,3.7,315,
35.795448,-78.69681,2025-04-14T10:07:05-04:00,69.76,370,
35.792427,-78.770381,2025-04-14T10:10:35-04:00,46.58,370,
35.789089,-78.783175,2025-04-14T10:12:32-04:00,0.06,370,
35.798946,-78.803096,2025-04-14T10:16:33-04:00,69.07,315,
35.860397,-78.845225,2025-04-14T10:21:05-04:00,76.11,315,
35.941768,-78.8492,2025-04-14T10:25:36-04:00,52.26,0,
35.996578,-78.905551,2025-04-14T10:31:37-04:00,23.75,315,
35.997638,-78.907504,2025-04-14T10:32:02-04:00,0.03,315,
35.998687,-78.909396,2025-04-14T10:35:33-04:00,26.84,315,
36.026916,-78.973689,2025-04-14T10:40:34-04:00,51.68,370,
36.036487,-79.05086,2025-04-14T10:46:05-04:00,49.47,225,
36.070526,-79.102656,2025-04-14T10:51:04-04:00,50.54,315,
36.078948,-79.176623,2025-04-14T10:56:05-04:00,53.11,370,
36.097988,-79.277606,2025-04-14T11:01:07-04:00,79.01,370,
36.091007,-79.352077,2025-04-14T11:07:04-04:00,47.34,370,
36.094577,-79.435351,2025-04-14T11:13:05-04:00,0.13,315,
36.101528,-79.49129,2025-04-14T11:16:34-04:00,70.3,225,
36.114017,-79.592555,2025-04-14T11:21:04-04:00,77.54,370,
36.092727,-79.687106,2025-04-14T11:26:07-04:00,55.46,225,
36.069107,-79.784816,2025-04-14T11:31:37-04:00,39.35,370,
36.068576,-79.787143,2025-04-14T11:32:07-04:00,0.02,370,
36.067718,-79.790416,2025-04-14T11:37:05-04:00,31.35,370,
36.052177,-79.86951,2025-04-14T11:41:37-04:00,65.41,370,
35.990077,-79.94247,2025-04-14T11:46:07-04:00,70.41,225,
35.960758,-79.997676,2025-04-14T11:49:06-04:00,63.09,225,
35.955966,-80.008914,2025-04-14T11:52:37-04:00,32.79,225,
35.923698,-80.039127,2025-04-14T11:56:37-04:00,42.3,225,
35.903678,-80.053256,2025-04-14T12:01:08-04:00,4.93,225,
35.882678,-80.082095,2025-04-14T12:06:07-04:00,38.26,225,
35.866058,-80.140849,2025-04-14T12:12:11-04:00,76.55,225,
35.824058,-80.239032,2025-04-14T12:16:39-04:00,67.47,225,
35.823047,-80.242694,2025-04-14T12:19:54-04:00,67.34,370,
35.763957,-80.304576,2025-04-14T12:22:06-04:00,69.33,225,
35.721916,-80.393054,2025-04-14T12:25:39-04:00,64.19,370,
35.668556,-80.46397,2025-04-14T12:31:38-04:00,30.4,225,
35.665946,-80.467349,2025-04-14T12:34:08-04:00,28.89,225,
35.642127,-80.508006,2025-04-14T12:36:08-04:00,78.92,225,
35.570628,-80.577831,2025-04-14T12:40:36-04:00,74.45,370,
35.499328,-80.622234,2025-04-14T12:46:05-04:00,55.07,225,
35.496387,-80.624126,2025-04-14T12:49:10-04:00,0.0,225,
35.469318,-80.621875,2025-04-14T12:52:06-04:00,73.94,180,
35.399898,-80.590061,2025-04-14T12:58:07-04:00,45.36,180,
35.336627,-80.619235,2025-04-14T13:02:36-04:00,74.14,225,
35.309077,-80.71606,2025-04-14T13:07:09-04:00,77.89,225,
35.242427,-80.820156,2025-04-14T13:13:08-04:00,29.27,225,
35.774607,-78.644003,2025-04-13T09:45:00-04:00,,,
35.775917,-78.646525,2025-04-13T10:01:57-04:00,5.23,315,
35.791316,-78.712519,2025-04-13T10:05:56-04:00,66.88,225,
35.792037,-78.771434,2025-04-13T10:10:57-04:00,0.0,370,
35.789089,-78.783099,2025-04-13T10:16:26-04:00,0.0,370,
35.789627,-78.784976,2025-04-13T10:19:28-04:00,35.96,370,
35.797569,-78.80054,2025-04-13T10:20:57-04:00,65.09,315,
35.860168,-78.845042,2025-04-13T10:25:57-04:00,76.53,315,
35.942878,-78.848964,2025-04-13T10:30:57-04:00,53.95,0,
35.997638,-78.907496,2025-04-13T10:36:28-04:00,0.16,315,
35.996948,-78.906276,2025-04-13T10:40:27-04:00,0.0,315,
35.998718,-78.909419,2025-04-13T10:42:29-04:00,32.29,315,
36.019828,-78.952266,2025-04-13T10:45:57-04:00,52.1,315,
36.033927,-79.025576,2025-04-13T10:50:57-04:00,52.28,370,
36.055366,-79.087596,2025-04-13T10:55:57-04:00,42.14,315,
36.072616,-79.145472,2025-04-13T11:00:56-04:00,50.49,370,
36.085506,-79.232303,2025-04-13T11:05:58-04:00,76.95,370,
36.092517,-79.325252,2025-04-13T11:10:56-04:00,44.25,225,
36.082027,-79.406734,2025-04-13T11:15:56-04:00,67.18,315,
36.094547,-79.435321,2025-04-13T11:17:56-04:00,0.25,315,
36.100128,-79.440944,2025-04-13T11:20:57-04:00,46.01,315,
36.102336,-79.530215,2025-04-13T11:25:59-04:00,66.01,370,
36.108695,-79.629466,2025-04-13T11:31:29-04:00,64.28,370,
36.085609,-79.721263,2025-04-13T11:36:32-04:00,78.44,370,
36.068626,-79.787051,2025-04-13T11:39:29-04:00,0.05,370,
36.067768,-79.79037,2025-04-13T11:43:34-04:00,38.53,370,
36.061557,-79.82719,2025-04-13T11:46:29-04:00,70.48,370,
36.011749,-79.90459,2025-04-13T11:51:02-04:00,77.06,225,
35.957416,-80.006183,2025-04-13T11:58:00-04:00,0.07,225,
35.956016,-80.008853,2025-04-13T12:02:31-04:00,24.59,225,
35.913665,-80.046596,2025-04-13T12:06:30-04:00,75.21,225,
35.867366,-80.138545,2025-04-13T12:11:01-04:00,77.96,225,
35.823097,-80.242404,2025-04-13T12:16:32-04:00,67.92,370,
35.767257,-80.302692,2025-04-13T12:20:31-04:00,70.4,225,
35.722907,-80.387645,2025-04-13T12:26:03-04:00,63.98,370,
35.668517,-80.464015,2025-04-13T12:31:33-04:00,39.28,225,
35.665927,-80.467395,2025-04-13T12:34:04-04:00,29.84,225,
35.653476,-80.493076,2025-04-13T12:36:02-04:00,77.7,225,
35.578807,-80.561244,2025-04-13T12:40:35-04:00,77.21,225,
35.502887,-80.61993,2025-04-13T12:46:33-04:00,59.49,225,
35.496467,-80.624065,2025-04-13T12:47:34-04:00,0.0,225,
35.494537,-80.625301,2025-04-13T12:51:32-04:00,31.52,225,
35.419696,-80.603992,2025-04-13T12:56:29-04:00,69.48,180,
35.358638,-80.590831,2025-04-13T13:01:34-04:00,58.08,180,
35.313567,-80.679614,2025-04-13T13:06:33-04:00,77.54,370,
35.263175,-80.759403,2025-04-13T13:10:34-04:00,78.32,370,
35.245807,-80.81435,2025-04-13T13:13:35-04:00,39.35,225,
35.245807,-80.81435,2025-04-13T13:17:09-04:00,0.0,,
35.774607,-78.644003,2025-04-12T09:45:00-04:00,,,
35.775867,-78.64664,2025-04-12T10:02:33-04:00,4.34,315,
35.795429,-78.696833,2025-04-12T10:07:03-04:00,78.06,370,
35.791229,-78.756602,2025-04-12T10:10:31-04:00,28.28,370,
35.792575,-78.769664,2025-04-12T10:16:29-04:00,0.0,370,
35.792205,-78.771029,2025-04-12T10:26:02-04:00,0.0,225,
35.791507,-78.772555,2025-04-12T10:34:04-04:00,26.71,225,
35.789035,-78.783046,2025-04-12T10:36:04-04:00,0.0,370,
35.789577,-78.784869,2025-04-12T10:38:33-04:00,24.2,370,
35.803848,-78.818965,2025-04-12T10:41:32-04:00,59.68,370,
35.878608,-78.853701,2025-04-12T10:45:34-04:00,75.27,0,
35.955997,-78.853206,2025-04-12T10:52:33-04:00,54.59,0,
35.997756,-78.90771,2025-04-12T10:55:32-04:00,0.0,315,
35.997077,-78.906474,2025-04-12T11:01:00-04:00,0.0,315,
35.998668,-78.90932,2025-04-12T11:02:06-04:00,25.23,315,
36.021457,-78.954783,2025-04-12T11:06:00-04:00,53.1,315,
36.034576,-79.028476,2025-04-12T11:11:39-04:00,52.88,370,
36.059356,-79.09106,2025-04-12T11:16:10-04:00,36.21,315,
36.074996,-79.150302,2025-04-12T11:21:10-04:00,48.55,315,
36.087387,-79.237826,2025-04-12T11:27:09-04:00,77.34,315,
36.090785,-79.33047,2025-04-12T11:31:20-04:00,47.31,370,
36.087818,-79.4285,2025-04-12T11:37:14-04:00,53.5,315,
36.095687,-79.436435,2025-04-12T11:40:20-04:00,21.54,315,
36.097248,-79.437816,2025-04-12T11:41:13-04:00,30.96,315,
36.101016,-79.518405,2025-04-12T11:46:12-04:00,60.7,370,
36.113376,-79.617412,2025-04-12T11:51:40-04:00,63.78,370,
36.086086,-79.706416,2025-04-12T11:56:23-04:00,70.73,370,
36.068748,-79.787051,2025-04-12T12:00:45-04:00,0.0,370,
36.065586,-79.799251,2025-04-12T12:07:25-04:00,53.03,370,
36.036708,-79.879916,2025-04-12T12:11:19-04:00,49.77,180,
35.980297,-79.951442,2025-04-12T12:16:21-04:00,69.06,225,
35.956935,-80.007304,2025-04-12T12:19:29-04:00,0.0,225,
35.956046,-80.008922,2025-04-12T12:22:16-04:00,28.4,225,
35.905498,-80.052097,2025-04-12T12:26:20-04:00,77.01,225,
35.863986,-80.14664,2025-04-12T12:31:26-04:00,76.75,225,
35.823108,-80.242557,2025-04-12T12:36:29-04:00,65.43,370,
35.761348,-80.306087,2025-04-12T12:41:46-04:00,70.26,225,
35.721488,-80.39458,2025-04-12T12:45:57-04:00,64.22,225,
35.666927,-80.466029,2025-04-12T12:51:56-04:00,0.0,225,
35.665977,-80.467304,2025-04-12T12:54:51-04:00,19.38,225,
35.655757,-80.487933,2025-04-12T12:56:49-04:00,72.97,225,
35.581767,-80.55833,2025-04-12T13:01:20-04:00,77.55,225,
35.502979,-80.619876,2025-04-12T13:06:55-04:00,54.81,225,
35.494457,-80.625354,2025-04-12T13:09:59-04:00,29.41,225,
35.486617,-80.6272,2025-04-12T13:11:16-04:00,60.47,180,
35.406596,-80.594707,2025-04-12T13:16:13-04:00,38.56,135,
35.343375,-80.60078,2025-04-12T13:20:51-04:00,73.93,225,
35.312778,-80.703624,2025-04-12T13:26:25-04:00,76.3,370,
35.253139,-80.781886,2025-04-12T13:31:30-04:00,77.54,225,
35.253139,-80.781886,2025-04-12T13:35:40-04:00,0.0,,
")



#km.data <- KMEANS.KNN::find_Kmeans_best_k(data = at_64rt[,c("longitude", "latitude")])

#View(km.data)

# cluster::clusplot(x = at_64rt[!is.na(at_64rt$speed),c("latitude", "longitude", "speed", "heading")])

clu_f <- cluster::fanny(x = at_64rt[!is.na(at_64rt$speed),c("speed")], 
               k = 5)


clu_f$clustering 

cluster::clusGap(x = at_64rt[!is.na(at_64rt$speed),c("speed")], 
                 FUNcluster = fanny, 
                 K.max = 5)


ggplot() + 
  geom_point(data = at_64rt[!is.na(at_64rt$speed),], 
             aes(x = longitude, y = latitude, 
                 color = factor(clu_f$clustering)))


ggplot() + 
  geom_point(aes(y = at_64rt[!is.na(at_64rt$speed),]$speed, 
                 x = clu_f$clustering))

args(clusplot)

at_64rt$date <- at_64rt$update_time %>% 
  with_tz(., tzone = "America/New_York") %>%
  as_date()

at_64rt %>%
  group_by(date, 
           hour_of_day = hour(with_tz(update_time, tzone = "America/New_York"))) %>%
  summarise(n = n(), 
            avg_heading = mean(heading, na.rm = T), 
            sd_hdg      = sd(heading, na.rm = T), 
            min_hdg     = min(heading, na.rm = T),
            max_hdg     = max(heading, na.rm = T))

at_64rt$heading %>% range(., na.rm = T)

ggplot(data = at_64rt, 
       aes(x = longitude, y = latitude)) + 
  geom_point(aes(size = speed))+
  geom_path(aes(group= date))+
  scale_size_area()+
  coord_quickmap()

lm(data = at_64rt, 
   formula = longitude~speed) %>% summary()



ggplot() + 
  geom_point(data = at_64rt, 
             aes(x = heading, 
                 y = hour(update_time) + 
                   minute(update_time)/60))

ggplot(data = at_64rt[at_64rt$heading %in% c(180,370) & 
                        !is.na(at_64rt$heading),]) + 
  geom_point(aes(x = longitude, 
                 y = latitude)) +
  geom_spoke(aes(x = longitude, 
                 y = latitude, 
                 angle = heading-90, 
                 radius = 0.1
                 ))+
  coord_quickmap()

table(at_64rt$heading
      )
